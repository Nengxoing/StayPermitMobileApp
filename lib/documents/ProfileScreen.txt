// D:\Nengxiong\Flutter\staypermitmobileapp\lib\screens\ProfileScreen.dart

import 'package:flutter/material.dart';
import 'package:intl/intl.dart';

class ProfileScreen extends StatefulWidget {
  const ProfileScreen({super.key});

  @override
  _ProfileScreenState createState() => _ProfileScreenState();
}

class _ProfileScreenState extends State<ProfileScreen> {
  final String defaultImagePath = 'assets/profile.jpeg';
  final String defaultQrCodePath = 'assets/MS THOUN LINKCHOU.png';
  final String policeLogo = 'assets/policelogo.png';

  // ข้อมูลทั้งหมดที่รวมอยู่ใน Object/Map
  final Map<String, dynamic> profileData = {
    'profile': {
      'firstName': 'MS THOUN',
      'lastName': 'LINKCHOU',
      'expCard':
          'ບັດຢັ້ງຢຶນພັກເຊົາຊົ່ວຄາວ - Temporary Stay Card (ມຽນມ້າ 6 ເດືອນ)',
      'cardStatus': 'ບັດໝົດອາຍຸການໃຊ້ງານ',
      'identityNumber': '203802',
      'phoneNumber': '11111111',
      'dateOfBirth': '1997-06-01',
      'gender': 'ຍິງ',
      'nationality': {'name': 'Myanmar'},
      'ethnicity': {'name': 'Myanmar'},
      'identityType': 'nationalId',
      'barcode': '12345678',
      'identityIssueDate': '2011-01-06',
      'identityExpiryDate': '2025-06-02',
      'district': {'districtLao': 'ຕົ້ນເຜິ້ງ'},
    },
    'cardDetails': {
      'cardType': 'NEW',
      'expirationTerm': 'SIX_MONTHS',
      'issueDate': '2011-01-06',
      'expirationDate': '2025-06-02',
      'cardCategory': 'YELLOW',
      'price': '80',
    },
    'employment': {
      'workPlace': 'ບໍລິສັດ ເບິນຍູເຈກົງຢຸ່ຍ ຈຳກັດຜູ້ດຽວ',
      'workNumber': '1',
      'position': {'laoName': 'ອະນາໄມ'},
      'officeName': 'ເສິ້ງໄທ້',
    },
    'location': {
      'villageLao': 'ເຂດພິເສດສາມຫລ່ຽມທອງຄຳ',
      'districtLao': 'ຕົ້ນເຜິ້ງ',
      'provinceLao': 'ບໍ່ແກ້ວ',
    },
    'overseasAddress': {
      'overseasProvince': 'MANDALAY',
      'overseasCountryId': 'Myanmar',
    },
    'media': {
      'imageUrl': '', // จะยังคงว่างเปล่าถ้าไม่มี URL จริง
      'qrcodeUrl': '', // จะยังคงว่างเปล่าถ้าไม่มี URL จริง
    },
  };

  String _safe(String key) {
    // แยก key ออกเป็นส่วนๆ เพื่อเข้าถึงข้อมูลใน Map ที่ซ้อนกัน
    final parts = key.split('.');
    dynamic currentData = profileData;
    for (var part in parts) {
      if (currentData is Map && currentData.containsKey(part)) {
        currentData = currentData[part];
      } else {
        return 'N/A'; // คืนค่า 'N/A' หากไม่พบ key
      }
    }
    return currentData.toString();
  }

  String _formatDate(String dateString) {
    if (dateString.isEmpty || dateString == 'N/A') return 'N/A';
    try {
      final DateTime date = DateTime.parse(dateString);
      return DateFormat('dd/MM/yyyy').format(date);
    } catch (e) {
      print('Error parsing date: $e');
      return dateString;
    }
  }

  void _showImageDialog(
    BuildContext context,
    String currentImageUrl,
    String defaultAssetPath,
  ) {
    showDialog(
      context: context,
      builder: (BuildContext context) {
        return Dialog(
          child: currentImageUrl.isNotEmpty
              ? Image.network(
                  currentImageUrl,
                  fit: BoxFit.contain,
                  errorBuilder: (_, __, ___) =>
                      Image.asset(defaultAssetPath, fit: BoxFit.contain),
                )
              : Image.asset(defaultAssetPath, fit: BoxFit.contain),
        );
      },
    );
  }

  Widget _buildField(String label, String value, {bool isRed = false}) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 1),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            '$label:',
            style: const TextStyle(
              fontSize: 7,
              fontWeight: FontWeight.w500,
              color: Colors.black,
            ),
          ),
          Text(
            value,
            style: TextStyle(
              fontSize: 7,
              color: isRed ? Colors.red : Colors.black,
            ),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final leftColumnData = [
      {'label': 'ຊື່/Name', 'key': 'profile.firstName'},
      {'label': 'ນາມສະກຸນ/Surname', 'key': 'profile.lastName'},
      {'label': 'ວັນເດືອນປີເກີດ/Date of Birth', 'key': 'profile.dateOfBirth'},
      {
        'label': 'ເອກະສານເດີນທາງ/Travel document',
        'key': 'profile.identityType',
      },
      {
        'label': 'ສະຖານທີ່ພັກເຊົາ/Living place',
        'key': 'profile.district.districtLao',
      },
    ];

    final rightColumnData = [
      {'label': 'ເຊື້ອຊາດ/Race', 'key': 'profile.ethnicity.name'},
      {'label': 'ສັນຊາດ/Nationality', 'key': 'profile.nationality.name'},
      {'label': 'ເລກທີ່/No', 'key': 'profile.identityNumber'},
    ];

    return Scaffold(
      backgroundColor: Colors.white,
      body: SingleChildScrollView(
        child: Column(
          children: [
            Padding(
              padding: const EdgeInsets.only(top: 20.0),
              child: Padding(
                padding: const EdgeInsets.symmetric(horizontal: 20.0),
                child: Container(
                  width: double.infinity,
                  decoration: BoxDecoration(
                    gradient: const LinearGradient(
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                      colors: [
                        Color.fromARGB(255, 247, 244, 228),
                        Color.fromARGB(255, 242, 225, 193),
                      ],
                    ),
                    border: Border.all(
                      color: const Color.fromARGB(255, 212, 210, 196),
                    ),
                    borderRadius: BorderRadius.circular(6),
                  ),
                  child: SingleChildScrollView(
                    padding: const EdgeInsets.all(8),
                    child: Row(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        // ---------- ຮູບ & QR ----------
                        Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              mainAxisAlignment: MainAxisAlignment.end,
                              children: [
                                ClipRRect(
                                  borderRadius: BorderRadius.circular(4),
                                  child: Image.asset(
                                    policeLogo,
                                    width: 30,
                                    fit: BoxFit.cover,
                                  ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 14),
                            GestureDetector(
                              onTap: () => _showImageDialog(
                                context,
                                profileData['media']['imageUrl'], // ดึงจาก profileData
                                defaultImagePath,
                              ),
                              child: ClipRRect(
                                borderRadius: BorderRadius.circular(4),
                                child:
                                    profileData['media']['imageUrl'].isNotEmpty
                                    ? Image.network(
                                        profileData['media']['imageUrl'], // ดึงจาก profileData
                                        width: 50,
                                        height: 50,
                                        fit: BoxFit.cover,
                                        errorBuilder: (_, __, ___) =>
                                            Image.asset(
                                              defaultImagePath,
                                              width: 50,
                                              height: 50,
                                              fit: BoxFit.cover,
                                            ),
                                      )
                                    : Image.asset(
                                        defaultImagePath,
                                        width: 50,
                                        height: 50,
                                        fit: BoxFit.cover,
                                      ),
                              ),
                            ),
                            const SizedBox(height: 14),
                            GestureDetector(
                              onTap: () => _showImageDialog(
                                context,
                                profileData['media']['qrcodeUrl'], // ดึงจาก profileData
                                defaultQrCodePath,
                              ),
                              child: ClipRRect(
                                borderRadius: BorderRadius.circular(4),
                                child:
                                    profileData['media']['qrcodeUrl'].isNotEmpty
                                    ? Image.network(
                                        profileData['media']['qrcodeUrl'], // ดึงจาก profileData
                                        width: 50,
                                        height: 50,
                                        fit: BoxFit.cover,
                                        errorBuilder: (_, __, ___) =>
                                            Image.asset(
                                              defaultQrCodePath,
                                              width: 50,
                                              height: 50,
                                              fit: BoxFit.cover,
                                            ),
                                      )
                                    : Image.asset(
                                        defaultQrCodePath,
                                        width: 50,
                                        height: 50,
                                        fit: BoxFit.cover,
                                      ),
                              ),
                            ),
                          ],
                        ),
                        const SizedBox(width: 10),
                        Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              // ------ ສ່ວນຫົວ ------
                              const Padding(
                                padding: EdgeInsets.only(left: 10),
                                child: Text(
                                  'ສາທາລະນະລັດ ປະຊາທິປະໄຕ ປະຊາຊົນລາວ',
                                  style: TextStyle(
                                    fontSize: 11,
                                    fontWeight: FontWeight.bold,
                                    color: Colors.black,
                                  ),
                                  textAlign: TextAlign.center,
                                ),
                              ),
                              const Padding(
                                padding: EdgeInsets.only(left: 18),
                                child: Text(
                                  "Lao People's Democratic Republic",
                                  style: TextStyle(
                                    fontSize: 10,
                                    fontWeight: FontWeight.bold,
                                    color: Colors.black,
                                  ),
                                  textAlign: TextAlign.center,
                                ),
                              ),
                              const Padding(
                                padding: EdgeInsets.only(left: 10),
                                child: Text(
                                  'ໃບຢັ້ງຢຶນການພັກຊາວຊົ່ວເຄົາ / Temporary Stay Card',
                                  style: TextStyle(
                                    fontSize: 8,
                                    fontWeight: FontWeight.w600,
                                    color: Colors.black,
                                  ),
                                ),
                              ),
                              const SizedBox(height: 8),

                              Row(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Column(
                                    crossAxisAlignment:
                                        CrossAxisAlignment.start,
                                    children: [
                                      _buildField(
                                        leftColumnData[0]['label']!,
                                        _safe(leftColumnData[0]['key']!),
                                      ),
                                      _buildField(
                                        leftColumnData[1]['label']!,
                                        _safe(leftColumnData[1]['key']!),
                                      ),
                                      _buildField(
                                        leftColumnData[2]['label']!,
                                        _formatDate(
                                          _safe(leftColumnData[2]['key']!),
                                        ),
                                      ),
                                      for (
                                        int i = 3;
                                        i < leftColumnData.length;
                                        i++
                                      )
                                        _buildField(
                                          leftColumnData[i]['label']!,
                                          _safe(leftColumnData[i]['key']!),
                                        ),
                                      Row(
                                        children: [
                                          const Text(
                                            'ໜ້າທີ່/Position:',
                                            style: TextStyle(
                                              fontSize: 7,
                                              fontWeight: FontWeight.w500,
                                              color: Colors.black,
                                            ),
                                          ),
                                          const SizedBox(width: 4),
                                          Text(
                                            _safe(
                                              'employment.position.laoName',
                                            ), // ดึงจาก profileData
                                            style: const TextStyle(
                                              fontSize: 7,
                                              color: Colors.black,
                                            ),
                                          ),
                                        ],
                                      ),

                                      // ออกให้วันที
                                      Row(
                                        children: [
                                          const Text(
                                            'ອອກໃຫ້ວັນທີ່:',
                                            style: TextStyle(
                                              fontSize: 7,
                                              fontWeight: FontWeight.w500,
                                              color: Colors.black,
                                            ),
                                          ),
                                          const SizedBox(width: 4),
                                          Text(
                                            _formatDate(
                                              _safe(
                                                'profile.identityIssueDate',
                                              ),
                                            ),
                                            style: const TextStyle(
                                              fontSize: 7,
                                              color: Colors.red,
                                            ),
                                          ),
                                        ],
                                      ),

                                      // หมดอายุ
                                      Row(
                                        children: [
                                          const Text(
                                            'ໝົດອະຍຸ:',
                                            style: TextStyle(
                                              fontSize: 7,
                                              fontWeight: FontWeight.w500,
                                              color: Colors.black,
                                            ),
                                          ),
                                          const SizedBox(width: 4),
                                          Text(
                                            _formatDate(
                                              _safe(
                                                'profile.identityExpiryDate',
                                              ),
                                            ),
                                            style: const TextStyle(
                                              fontSize: 7,
                                              color: Colors.red,
                                            ),
                                          ),
                                        ],
                                      ),
                                    ],
                                  ),

                                  const SizedBox(width: 20),
                                  Column(
                                    crossAxisAlignment:
                                        CrossAxisAlignment.start,
                                    children: [
                                      Row(
                                        children: [
                                          const Text(
                                            "ເລກທີ່:",
                                            style: TextStyle(fontSize: 7),
                                          ),
                                          const SizedBox(width: 4),
                                          Text(
                                            _safe('profile.barcode'),
                                            style: const TextStyle(fontSize: 7),
                                          ),
                                          const Text(
                                            '/ຄຕທ',
                                            style: TextStyle(fontSize: 7),
                                          ),
                                        ],
                                      ),
                                      for (final f in rightColumnData)
                                        _buildField(
                                          f['label']!,
                                          _safe(f['key']!),
                                        ),
                                      Stack(
                                        alignment: Alignment.center,
                                        children: [
                                          Opacity(
                                            opacity: .8,
                                            child: Image.asset(
                                              'assets/immigration.png',
                                              width: 50,
                                              fit: BoxFit.contain,
                                            ),
                                          ),
                                          const Column(
                                            children: [
                                              Text(
                                                "ກົມຕຳຫຼວດຄຸ້ມຄອງຄົນຕ່າງປະເທດ",
                                                style: TextStyle(
                                                  fontSize: 7,
                                                  fontWeight: FontWeight.bold,
                                                ),
                                              ),
                                              Text(
                                                "Department of Foreigner Control",
                                                style: TextStyle(
                                                  fontSize: 7,
                                                  fontWeight: FontWeight.bold,
                                                ),
                                              ),
                                            ],
                                          ),
                                        ],
                                      ),
                                    ],
                                  ),
                                ],
                              ),
                            ],
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              ),
            ),
            Padding(
              padding: const EdgeInsets.only(top: 1, bottom: 1),
              child: Column(
                children: [
                  const SizedBox(height: 20),
                  Text(
                    "${profileData['profile']['firstName']} ${profileData['profile']['lastName']}", // ใช้จาก profileData
                    style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold),
                  ),
                  const SizedBox(height: 20),
                  Padding(
                    padding: const EdgeInsets.only(left: 30, right: 30),
                    child: Text(
                      profileData['profile']['expCard'], // ใช้จาก profileData
                      textAlign: TextAlign.center,
                      style: TextStyle(
                        fontSize: 16,
                        color: Colors.grey.shade600,
                      ),
                    ),
                  ),
                  const SizedBox(height: 5),
                  Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(Icons.cancel, color: Colors.red, size: 20),
                      SizedBox(width: 6),
                      Text(
                        profileData['profile']['cardStatus'], // ใช้จาก profileData
                        style: TextStyle(
                          fontSize: 16,
                          color: Colors.red,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 10),
                ],
              ),
            ),
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 16.0),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  _buildSectionHeader('ຂໍ້ມູນສ່ວນຕົວ', Icons.person_outline),
                  _buildInfoCard([
                    _buildInfoRow(
                      'ເລກຟອມ:',
                      profileData['profile']['identityNumber'],
                    ), // ใช้จาก profileData
                    _buildInfoRow(
                      'ເບີໂທ:',
                      profileData['profile']['phoneNumber'],
                    ), // ใช้จาก profileData
                    _buildInfoRow(
                      'ວັນເດືອນປີເກີດ:',
                      _formatDate(
                        profileData['profile']['dateOfBirth'],
                      ), // ใช้จาก profileData
                    ),
                    _buildInfoRow(
                      'ເພດ:',
                      profileData['profile']['gender'],
                    ), // ใช้จาก profileData
                    _buildInfoRow(
                      'ສັນຊາດ:',
                      profileData['profile']['nationality']['name'],
                    ), // ใช้จาก profileData
                    _buildInfoRow(
                      'ເຊື້ອຊາດ:',
                      profileData['profile']['ethnicity']['name'],
                    ), // ใช้จาก profileData
                    _buildInfoRow(
                      'ປະເພດເອກະສານ:',
                      profileData['profile']['identityType'],
                    ), // ใช้จาก profileData
                  ]),
                  const SizedBox(height: 25),
                  _buildSectionHeader(
                    'ລາຍລະອຽດບັດ',
                    Icons.credit_card_outlined,
                  ),
                  _buildInfoCard([
                    _buildInfoRow(
                      'ປະເພດ:',
                      profileData['cardDetails']['cardType'],
                    ), // ใช้จาก profileData
                    _buildInfoRow(
                      'ໄລຍະເວລາ:',
                      profileData['cardDetails']['expirationTerm'],
                    ), // ใช้จาก profileData
                    _buildInfoRow(
                      'ອອກໃຫ້ວັນທີ:',
                      _formatDate(
                        profileData['cardDetails']['issueDate'],
                      ), // ใช้จาก profileData
                    ),
                    _buildInfoRow(
                      'ວັນໝົດວັນທີ:',
                      _formatDate(
                        profileData['cardDetails']['expirationDate'],
                      ), // ใช้จาก profileData
                    ),
                    _buildInfoRow(
                      'ປະເພດບັດ:',
                      profileData['cardDetails']['cardCategory'],
                    ), // ใช้จาก profileData
                    _buildInfoRow(
                      'ລາຄາ:',
                      '\$${profileData['cardDetails']['price']}',
                    ), // ใช้จาก profileData
                  ]),
                  const SizedBox(height: 25),
                  _buildSectionHeader('ການຈ້າງງານ', Icons.work_outline),
                  _buildInfoCard([
                    _buildInfoRow(
                      'ບໍລິສັດ:',
                      profileData['employment']['workPlace'],
                    ), // ใช้จาก profileData
                    _buildInfoRow(
                      'ລະຫັດທຸລະກິດ:',
                      profileData['employment']['workNumber'],
                    ), // ใช้จาก profileData
                    _buildInfoRow(
                      'ຕຳແໜ່ງ:',
                      profileData['employment']['position']['laoName'],
                    ), // ใช้จาก profileData
                    _buildInfoRow(
                      'ສຳນັກງານ:',
                      profileData['employment']['officeName'],
                    ), // ใช้จาก profileData
                  ]),
                  const SizedBox(height: 25),
                  _buildSectionHeader('ສະຖານທີ່', Icons.location_on_outlined),
                  _buildInfoCard([
                    _buildInfoRow(
                      'ບ້ານ:',
                      profileData['location']['villageLao'],
                    ), // ใช้จาก profileData
                    _buildInfoRow(
                      'ເມືອງ:',
                      profileData['location']['districtLao'],
                    ), // ใช้จาก profileData
                    _buildInfoRow(
                      'ແຂວງ:',
                      profileData['location']['provinceLao'],
                    ), // ใช้จาก profileData
                  ]),
                  const SizedBox(height: 25),
                  _buildSectionHeader('ທີ່ຢູ່ຕ່າງປະເທດ', Icons.public_outlined),
                  _buildInfoCard([
                    _buildInfoRow(
                      'ແຂວງ:',
                      profileData['overseasAddress']['overseasProvince'],
                    ), // ใช้จาก profileData
                    _buildInfoRow(
                      'ປະເທດ:',
                      profileData['overseasAddress']['overseasCountryId'],
                    ), // ใช้จาก profileData
                  ]),
                  const SizedBox(height: 20),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildSectionHeader(String title, IconData icon) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 10.0),
      child: Row(
        children: [
          Icon(icon, size: 26, color: Colors.black),
          const SizedBox(width: 10),
          Text(
            title,
            style: const TextStyle(
              fontSize: 20,
              fontWeight: FontWeight.bold,
              color: Colors.black87,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildInfoCard(List<Widget> children) {
    return Card(
      margin: const EdgeInsets.symmetric(vertical: 5.0),
      elevation: 3,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(12),
        side: const BorderSide(
          color: Color.fromARGB(255, 88, 88, 88),
          width: 0.3,
        ),
      ),
      color: const Color.fromARGB(255, 255, 254, 245),
      child: Padding(
        padding: const EdgeInsets.all(18.0),
        child: Column(children: children),
      ),
    );
  }

  Widget _buildInfoRow(String label, String value) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 8.0),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(
            label,
            style: TextStyle(
              fontSize: 15,
              color: Color.fromARGB(255, 112, 112, 112),
              fontWeight: FontWeight.w500,
            ),
          ),
          Flexible(
            child: Text(
              value,
              textAlign: TextAlign.right,
              style: const TextStyle(
                fontSize: 16,
                color: Color.fromARGB(255, 112, 112, 112),
                // fontWeight: FontWeight.w600,
              ),
            ),
          ),
        ],
      ),
    );
  }
}
